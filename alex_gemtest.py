import google.generativeai as genai
import os
import time
import io
import json
import requests
from PIL import Image
from .. import loader, utils
import aiohttp

@loader.tds
class alexis_gemini(loader.Module):
    """–ú–æ–¥—É–ª—å –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å Gemini AI –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π"""

    strings = {"name": "alexis_gemini"}

    def __init__(self):
        self.config = loader.ModuleConfig(
            loader.ConfigValue("api_key", "", "API –∫–ª—é—á –¥–ª—è Gemini AI", validator=loader.validators.Hidden(loader.validators.String())),
            loader.ConfigValue("model_name", "gemini-1.5-flash", "–ú–æ–¥–µ–ª—å –¥–ª—è Gemini AI", validator=loader.validators.String()),
            loader.ConfigValue("system_instruction", "", "–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è Gemini AI", validator=loader.validators.String()),
            loader.ConfigValue("proxy", "", "–ü—Ä–æ–∫—Å–∏", validator=loader.validators.String()),
            loader.ConfigValue("default_image_model", "flux", "–ú–æ–¥–µ–ª—å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π", validator=loader.validators.String()),
        )

    async def client_ready(self, client, db):
        self.client = client

    def _get_mime_type(self, message):
        if not message:
            return None

        try:
            if getattr(message, "video", None) or getattr(message, "video_note", None):
                return "video/mp4"
            elif getattr(message, "animation", None) or (getattr(message, "sticker", None) and getattr(message.sticker, "is_video", False)):
                return "video/mp4"
            elif getattr(message, "voice", None) or getattr(message, "audio", None):
                return "audio/wav"
            elif getattr(message, "photo", None):
                return "image/png"
            elif getattr(message, "sticker", None):
                return "image/webp"
        except AttributeError:
            return None

        return None

    async def generate_image(self, prompt):
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Flux –∏–ª–∏ –¥—Ä—É–≥–æ–π –º–æ–¥–µ–ª–∏"""
        start_time = time.time()

        payload = {
            "model": self.config["default_image_model"],
            "prompt": prompt,
            "response_format": "url"
        }

        try:
            async with aiohttp.ClientSession() as session:
                async with session.post("https://api.kshteam.top/v1/images/generate", headers={"Authorization": f"Bearer {self.config['api_key']}", "Content-Type": "application/json"}, json=payload) as response:
                    generation_time = round(time.time() - start_time, 2)
                    if response.status == 200:
                        data = await response.json()
                        image_url = data.get("data", [{}])[0].get("url", None)

                        if image_url:
                            return image_url, generation_time
                        else:
                            return None, "–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"
                    else:
                        return None, f"–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: {response.status}"
        except Exception as e:
            return None, f"–û—à–∏–±–∫–∞: {str(e)}"

    @loader.command()
    async def ghist(self, message):
        """–ê–Ω–∞–ª–∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 400 —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞ —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –æ—Ç—á–µ—Ç–∞"""
        if not self.config["api_key"]:
            await message.edit("<emoji document_id=5274099962655816924>‚ùóÔ∏è</emoji> API –∫–ª—é—á –Ω–µ —É–∫–∞–∑–∞–Ω. –ü–æ–ª—É—á–∏—Ç–µ –µ–≥–æ –Ω–∞ aistudio.google.com/apikey")
            return
        
        # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 400 —Å–æ–æ–±—â–µ–Ω–∏–π
        chat_id = message.chat_id
        last_400_messages = []
        async for msg in self.client.iter_messages(chat_id, limit=400):
            if msg.text:
                last_400_messages.append(msg.text)
        
        # –ü–µ—Ä–µ–¥–∞–µ–º –≤—Å–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤ Gemini
        chat_text = "\n\n".join(last_400_messages)
        result = await self.analyze_chat_history(chat_text)
        await message.edit(result)

    async def analyze_chat_history(self, chat_text):
        """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç —á–∞—Ç–∞ —Å –ø–æ–º–æ—â—å—é Gemini –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫—Ä–∞—Ç–∫–∏–π –æ—Ç—á–µ—Ç"""
        try:
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –¥–ª—è Gemini
            prompt = f"–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –ø–æ–¥—ã—Ç–æ–∂–∏, —á—Ç–æ –æ–±—Å—É–∂–¥–∞–ª–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∏ —á–∞—Ç–∞:\n\n{chat_text}"
            genai.configure(api_key=self.config["api_key"])
            model = genai.GenerativeModel(
                model_name=self.config["model_name"],
                system_instruction=self.config["system_instruction"] or None,
            )
            content_parts = [genai.protos.Part(text=prompt)]
            response = model.generate_content(content_parts)
            reply_text = response.text.strip() if response.text else "–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞."

            return f"–ß—Ç–æ —Å–µ–≥–æ–¥–Ω—è –æ–±—Å—É–∂–¥–∞–ª–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∏ —á–∞—Ç–∞?\n\n{reply_text}"

        except Exception as e:
            return f"<emoji document_id=5274099962655816924>‚ùóÔ∏è</emoji> –û—à–∏–±–∫–∞: {str(e)}"

    @loader.command()
    async def geminicmd(self, message):
        """<reply to media/text> ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∫ Gemini"""
        if not self.config["api_key"]:
            await message.edit("<emoji document_id=5274099962655816924>‚ùóÔ∏è</emoji> API –∫–ª—é—á –Ω–µ —É–∫–∞–∑–∞–Ω. –ü–æ–ª—É—á–∏—Ç–µ –µ–≥–æ –Ω–∞ aistudio.google.com/apikey")
            return

        prompt = utils.get_args_raw(message)
        media_path = None
        img = None
        show_question = True  # –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–æ–ø—Ä–æ—Å, –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç

        if message.is_reply:
            reply = await message.get_reply_message()
            mime_type = self._get_mime_type(reply)

            if mime_type:
                media_path = await reply.download_media()
                if not prompt:
                    prompt = "–û–ø–∏—à–∏ —ç—Ç–æ"  # –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –º–µ–¥–∏–∞ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞
                    await message.edit("<emoji document_id=5386367538735104399>‚åõÔ∏è</emoji> –û–ø–∏—à–∏ —ç—Ç–æ...")
                    show_question = False  # –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å "–í–æ–ø—Ä–æ—Å:", –µ—Å–ª–∏ –∑–∞–≥–ª—É—à–∫–∞
            else:
                prompt = prompt or reply.text

        if media_path and mime_type and mime_type.startswith("image"):
            try:
                img = Image.open(media_path)
            except Exception as e:
                await message.edit(f"<emoji document_id=5274099962655816924>‚ùóÔ∏è</emoji> –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: {e}")
                os.remove(media_path)
                return

        if not prompt and not img and not media_path:
            await message.edit("<emoji document_id=5274099962655816924>‚ùóÔ∏è</emoji> –í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –≤–∏–¥–µ–æ, GIF, —Å—Ç–∏–∫–µ—Ä, –≥–æ–ª–æ—Å–æ–≤–æ–µ)")
            return

        await message.edit("<emoji document_id=5325547803936572038>‚ú®</emoji> –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω, –æ–∂–∏–¥–∞–π—Ç–µ –æ—Ç–≤–µ—Ç...")

        try:
            genai.configure(api_key=self.config["api_key"])
            model = genai.GenerativeModel(
                model_name=self.config["model_name"],
                system_instruction=self.config["system_instruction"] or None,
            )

            content_parts = []
            if prompt:
                content_parts.append(genai.protos.Part(text=prompt))

            if media_path:
                with open(media_path, "rb") as f:
                    content_parts.append(genai.protos.Part(
                        inline_data=genai.protos.Blob(
                            mime_type=mime_type,
                            data=f.read()
                        )
                    ))

            if not content_parts:
                await message.edit("<emoji document_id=5274099962655816924>‚ùóÔ∏è</emoji> –û—à–∏–±–∫–∞: –ó–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–µ–∫—Å—Ç –∏–ª–∏ –º–µ–¥–∏–∞.")
                return

            response = model.generate_content(content_parts)
            reply_text = response.text.strip() if response.text else "<emoji document_id=5274099962655816924>‚ùóÔ∏è</emoji> –û—Ç–≤–µ—Ç –ø—É—Å—Ç–æ–π."

            random_emojis = [
                "<emoji document_id=5440588507254896965>ü§®</emoji>",
                "<emoji document_id=5443135817998416433>üòï</emoji>",
                "<emoji document_id=5442828624757536533>üòÇ</emoji>",
                "<emoji document_id=5443072677684197457>üòò</emoji>",
                "<emoji document_id=5440854425860061667>üëπ</emoji>",
                "<emoji document_id=5443073472253148107>ü§ì</emoji>",
                "<emoji document_id=5440693467665677594>üö¨</emoji>",
                "<emoji document_id=5440883077586893345>‚òïÔ∏è</emoji>",
                "<emoji document_id=5442843472459481786>ü•≥</emoji>",
                "<emoji document_id=5442927761192665683>ü§≤</emoji>",
                "<emoji document_id=5440814207786303456>üòé</emoji>",
                "<emoji document_id=5442924243614447997>üò°</emoji>",
                "<emoji document_id=5440804385196096498>üëã</emoji>",
                "<emoji document_id=5442795081062956585>‚úã</emoji>",
                "<emoji document_id=5442874134231008257>üëç</emoji>",
                "<emoji document_id=5442639916779454280>üñê</emoji>",
                "<emoji document_id=5442634539480400651>üò∂</emoji>",
                "<emoji document_id=5443010220269782390>üòå</emoji>",
                "<emoji document_id=5440581390494090067>üò≤</emoji>",
                "<emoji document_id=5442674890698145284>üòß</emoji>",
                "<emoji document_id=5443037587801389289>üì≤</emoji>",
                "<emoji document_id=5442864698187856287>üëú</emoji>",
                "<emoji document_id=5442936205098369573>üòê</emoji>",
                "<emoji document_id=5443129680490152331>üëã</emoji>",
                "<emoji document_id=5442868116981824547>üîî</emoji>",
                "<emoji document_id=5440388529282629473>ü´•</emoji>",
                "<emoji document_id=5442876913074847850>üßÆ</emoji>",
                "<emoji document_id=5442644336300802689>üö¨</emoji>",
                "<emoji document_id=5442714550426157926>ü¶¥</emoji>",
                "<emoji document_id=5442869822083841917>üò¥</emoji>",
                "<emoji document_id=5442895299829843652>üò≥</emoji>",
                "<emoji document_id=5443106182724076636>üç´</emoji>",
                "<emoji document_id=5443135796523579899>üíÉ</emoji>",
                "<emoji document_id=5442741651669795615>üò±</emoji>",
                "<emoji document_id=5442613657349405621>üññ</emoji>",
                "<emoji document_id=5442672781869204635>üéâ</emoji>",
                "<emoji document_id=5440474033491560675>‚ò∫Ô∏è</emoji>",
                "<emoji document_id=5442979910685573674>üëç</emoji>",
                "<emoji document_id=5442873906597741574>üó£</emoji>",
                "<emoji document_id=5440412353466222950>üò∂‚Äçüå´Ô∏è</emoji>",
                "<emoji document_id=5442938782078746258>üòÉ</emoji>",
                "<emoji document_id=5443087564040847705>üò†</emoji>",
                "<emoji document_id=5440702594471182364>üêΩ</emoji>",
                "<emoji document_id=5442641505917352670>üí¢</emoji>",
                "<emoji document_id=5444907646626838669>ü•∞</emoji>",
                "<emoji document_id=5445374977723349942>üòí</emoji>",
                "<emoji document_id=5442881062013254513>üòä</emoji>",
                "<emoji document_id=5445375935501055831>üòê</emoji>",
                "<emoji document_id=5445360628237614380>üåÖ</emoji>",
                "<emoji document_id=5445079806095933151>üò¶</emoji>",
                "<emoji document_id=5444946571915444568>ü§∑‚Äç‚ôÇÔ∏è</emoji>",
                "<emoji document_id=5445017237012363750>ü•≥</emoji>",
                "<emoji document_id=5442859243579393479>ü§¶‚Äç‚ôÄÔ∏è</emoji>",
                "<emoji document_id=5444950785278362209>üòé</emoji>",
                "<emoji document_id=5445398230676291110>ü§£</emoji>",
                "<emoji document_id=5445333290770775391>üëÄ</emoji>",
                "<emoji document_id=5445255122365988661>üòï</emoji>",
                "<emoji document_id=5445159739732279716>ü´•</emoji>",
                "<emoji document_id=5447594277519505787>üòå</emoji>",
                "<emoji document_id=5444909231469771073>üëç</emoji>",
                "<emoji document_id=5445144823310859690>‚ò†Ô∏è</emoji>",
                "<emoji document_id=5445178796502171599>üíÄ</emoji>",
                "<emoji document_id=5445021368770905143>üéß</emoji>",
                "<emoji document_id=5444963197733846783>üò≠</emoji>",
                "<emoji document_id=5444953903424616983>üôÇ</emoji>",
                "<emoji document_id=5445281673853813075>ü§î</emoji>",
                "<emoji document_id=5444879089389289261>üëå</emoji>",
                "<emoji document_id=5444884879005204566>üò®</emoji>",
                "<emoji document_id=5445069897606381495>üòã</emoji>",
                "<emoji document_id=5445141215538329626>üòÖ</emoji>",
                "<emoji document_id=5444875919703424395>‚ñ∂Ô∏è</emoji>",
                "<emoji document_id=5445324125310567405>‚è∞</emoji>",
                "<emoji document_id=5447657447898496804>üòï</emoji>",
                "<emoji document_id=5447437455378627555>ü§¨</emoji>",
                "<emoji document_id=5449419466821618942>üò±</emoji>",
                "<emoji document_id=5447455666039963228>üí¶</emoji>",
                "<emoji document_id=5449777078683582032>ü•ï</emoji>",
                "<emoji document_id=5447417329161879977>ü§¶‚Äç‚ôÄÔ∏è</emoji>",
                "<emoji document_id=5447214563755836578>üôà</emoji>",
                "<emoji document_id=5447152020442070774>üî´</emoji>",
                "<emoji document_id=5447123909881117332>üñï</emoji>",
                "<emoji document_id=5449728399524249126>üêª</emoji>",
                "<emoji document_id=5447440066718743386>üç∫</emoji>",
                "<emoji document_id=5447153218737949833>ü§¶</emoji>",
                "<emoji document_id=5447223407093497907>‚ò∫Ô∏è</emoji>",
                "<emoji document_id=5447482135923406987>üå∫</emoji>",
                "<emoji document_id=5447118373668274107>üòà</emoji>",
                "<emoji document_id=5447504955084652371>‚ö∞Ô∏è</emoji>",
                "<emoji document_id=5449461939753204225>ü§©</emoji>",
                "<emoji document_id=5449918091049844581>üÜí</emoji>",
                "<emoji document_id=5449356850493406098>‚ùÑÔ∏è</emoji>",
                "<emoji document_id=5447103766484499962>üòÇ</emoji>",
                "<emoji document_id=5382065579232347995>üôÑ</emoji>",
                "<emoji document_id=5382255777564083766>üòí</emoji>",
                "<emoji document_id=5382160888851615895>üòÑ</emoji>",
                "<emoji document_id=5382243558382144304>üëÜ</emoji>",
                "<emoji document_id=5381982145197654105>üò®</emoji>",
                "<emoji document_id=5262687736334139937>ü§ê</emoji>",
                "<emoji document_id=5265154593750271127>üòä</emoji>",
                "<emoji document_id=5265180513877903121>üòï</emoji>",
                "<emoji document_id=5292183561678375848>üòÅ</emoji>",
                "<emoji document_id=5292092972228169457>üòß</emoji>",
                "<emoji document_id=5294439768128508029>‚ò∫Ô∏è</emoji>",
                "<emoji document_id=5291813515886089464>üé©</emoji>",
                "<emoji document_id=5294269446905416769>üòé</emoji>",
                "<emoji document_id=5278474666019665313>üåü</emoji>",
                "<emoji document_id=5278273197693743570>üåü</emoji>",
                "<emoji document_id=5278340607205453195>üåü</emoji>",
                "<emoji document_id=5319299223521338293>üò±</emoji>",
                "<emoji document_id=5319055531371930585>üôÖ‚Äç‚ôÇÔ∏è</emoji>",
                "<emoji document_id=5319016550248751722>üëã</emoji>",
                "<emoji document_id=5318773107207447403>üò±</emoji>",
                "<emoji document_id=5319018096436977294>üî´</emoji>",
                "<emoji document_id=5319116781900538765>üò£</emoji>",
                "<emoji document_id=5229159576649093081>‚ù§Ô∏è</emoji>",
                "<emoji document_id=5456439526442409796>üëç</emoji>",
                "<emoji document_id=5458837140395793861>üëé</emoji>",
                "<emoji document_id=5456307778320603813>üòè</emoji>"
            ]
            from random import choice
            random_emoji = choice(random_emojis)

            if show_question and prompt != "–û–ø–∏—à–∏ —ç—Ç–æ":
                await message.edit(f"<emoji document_id=5443038326535759644>üí¨</emoji> –í–æ–ø—Ä–æ—Å: {prompt}\n<emoji document_id=5325547803936572038>‚ú®</emoji> –û—Ç–≤–µ—Ç –æ—Ç Gemini: {reply_text} {random_emoji}")
            else:
                await message.edit(f"<emoji document_id=5325547803936572038>‚ú®</emoji> –û—Ç–≤–µ—Ç –æ—Ç Gemini: {reply_text} {random_emoji}")
        except Exception as e:
            await message.edit(f"<emoji document_id=5274099962655816924>‚ùóÔ∏è</emoji> –û—à–∏–±–∫–∞: {e}")
        finally:
            if media_path:
                os.remove(media_path)
